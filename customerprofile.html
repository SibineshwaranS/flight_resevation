<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Customer Profile - FlightReserve</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --brand: #6f42c1;
      --gradient: linear-gradient(135deg, #6f42c1, #a78bfa);
      --ink: #1f2937;
      --muted: #6b7280;
      --bg-soft: #f8f9fc; /* Matching homepage background */
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-soft);
      color: var(--ink);
    }
    
    /* Back Button Styling (Replaces Navbar) */
    .header-bar {
        padding-top: 20px;
        padding-bottom: 20px;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: rgba(248, 249, 252, 0.8); /* Semi-transparent bg-soft */
        backdrop-filter: blur(10px);
        z-index: 1030;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .navbar-brand {
      font-weight: 800;
      font-size: 1.6rem;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      color: transparent;
    }
    .btn-back {
        font-weight: 600;
        background: var(--gradient);
        color: #fff !important;
        border-radius: 30px;
        padding: 8px 18px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: none;
        transition: 0.3s;
        box-shadow: 0 4px 12px rgba(111, 66, 193, 0.2);
    }
    .btn-back:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(111, 66, 193, 0.35);
    }

    /* Profile Section */
    .profile-section {
      padding-top: 120px; /* Increased padding to account for fixed header */
      padding-bottom: 80px;
    }
    .profile-card {
      background: #fff;
      border-radius: 20px; /* Matched homepage card style */
      padding: 40px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.08);
      border: none;
    }
    .profile-photo-wrapper {
      text-align: center;
    }
    .profile-photo {
      width: 160px;
      height: 160px;
      object-fit: cover;
      border-radius: 50%;
      border: 5px solid #fff; /* White border for pop */
      box-shadow: 0 0 0 4px var(--brand), 0 4px 15px rgba(0,0,0,0.2);
    }
    .form-label {
      font-weight: 600;
      color: var(--muted);
    }
    .form-control, .form-select {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 10px;
      transition: all 0.3s;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.2);
    }
    .btn-brand { /* This is your "Save Profile" button */
      background: var(--gradient);
      border: none;
      padding: 12px 28px;
      border-radius: 30px;
      font-weight: 600;
      color: #fff;
      transition: all 0.3s ease;
    }
    .btn-brand:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(111, 66, 193, 0.4);
    }
    .section-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--brand);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title i {
      font-size: 1.3rem;
    }
  </style>
  </head>
<body>

<header class="header-bar">
    <div class="container d-flex justify-content-between align-items-center">
        <a class="navbar-brand" href="/homepage.html">FlightReserve</a>
        <button class="btn-back" onclick="goBack()">
            <i class="bi bi-arrow-left-circle"></i>
            <span>Back</span>
        </button>
    </div>
</header>
<section class="profile-section">
  <div class="container">
    <div class="profile-card">
      <div class="row g-5 align-items-center">
        
        <div class="col-md-4 profile-photo-wrapper">
          <img id="previewPhoto" class="profile-photo" src="https://placehold.co/160x160/6f42c1/FFFFFF?text=Profile" alt="Profile Photo">
          <input type="file" id="photoInput" class="form-control mt-4" accept="image/*">
        </div>

        <div class="col-md-8">
          <h2 class="fw-bold mb-4">My Personal Information</h2>
          <form id="profileForm">
            
            <div class="section-title"><i class="bi bi-person-lines-fill"></i> Personal Info</div>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Full Name</label>
                <input type="text" id="full_name" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">Date of Birth</label>
                <input type="date" id="date_of_birth" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">Gender</label>
                <select id="gender" class="form-select">
                  <option value="">Select</option>
                  <option>Male</option>
                  <option>Female</option>
                  <option>Other</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Nationality</label>
                <input type="text" id="nationality" class="form-control">
              </div>
            </div>

            <div class="section-title mt-4"><i class="bi bi-passport"></i> Travel Details</div>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Passport No</label>
                <input type="text" id="passport_no" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">Frequent Flyer No</label>
                <input type="text" id="frequent_flyer_no" class="form-control">
              </div>
            </div>

            <div class="section-title mt-4"><i class="bi bi-geo-alt"></i> Contact Info</div>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Address</label>
                <input type="text" id="address" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">City</label>
                <input type="text" id="city" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">Country</label>
                <input type="text" id="country" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">Phone</label>
                <input type="text" id="phone" class="form-control">
              </div>
            </div>

            <div class="d-flex justify-content-end mt-4">
              <button type="button" class="btn-brand" onclick="saveProfile()">
                <i class="bi bi-save2 me-2"></i> Save Profile
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let userId = null;
let profileExists = false;
const backendUrl = "https://flight-reservation-api-xv04.onrender.com";

// ⭐⭐⭐ START OF SCRIPT CHANGES ⭐⭐⭐
// Simple function to navigate to the previous page in history
function goBack() {
    window.history.back();
}
// ⭐⭐⭐ END OF SCRIPT CHANGES ⭐⭐⭐


// ✅ Get logged-in user from localStorage
const storedUser = localStorage.getItem("user");
if (storedUser) {
    const user = JSON.parse(storedUser);
    userId = user.id;
} else {
    showToast("⚠️ Please log in first!", "warning");
    setTimeout(() => { window.location.href = "/login.html"; }, 2000);
}

// ✅ Preview photo when a new file is selected
document.getElementById("photoInput").addEventListener("change", e => {
    const file = e.target.files[0];
    if (file) {
        document.getElementById("previewPhoto").src = URL.createObjectURL(file);
    }
});

// ✅ Fetch profile when the page loads (if user is logged in)
if (userId) {
    document.addEventListener("DOMContentLoaded", fetchProfile);
}

async function fetchProfile() {
    try {
        const res = await fetch(`${backendUrl}/customers/read/${userId}`);
        
        if (res.status === 404) {
            profileExists = false;
            document.getElementById("previewPhoto").src = "https://placehold.co/160x160/6f42c1/FFFFFF?text=Profile";
            return;
        }

        if (!res.ok) throw new Error(`Server returned ${res.status}`);
        
        const data = await res.json();
        profileExists = true;

        document.getElementById("full_name").value = data.full_name || "";
        document.getElementById("date_of_birth").value = data.date_of_birth ? data.date_of_birth.split("T")[0] : "";
        document.getElementById("gender").value = data.gender || "";
        document.getElementById("nationality").value = data.nationality || "";
        document.getElementById("passport_no").value = data.passport_no || "";
        document.getElementById("frequent_flyer_no").value = data.frequent_flyer_no || "";
        document.getElementById("address").value = data.address || "";
        document.getElementById("city").value = data.city || "";
        document.getElementById("country").value = data.country || "";
        document.getElementById("phone").value = data.phone || "";

        const photoUrl = `${backendUrl}/customers/photo/${userId}?t=${new Date().getTime()}`;
        
        const photoRes = await fetch(photoUrl);
        if (photoRes.ok) {
            document.getElementById("previewPhoto").src = photoUrl;
        } else {
            document.getElementById("previewPhoto").src = "https://placehold.co/160x160/6f42c1/FFFFFF?text=Profile";
        }

    } catch (err) {
        console.error("Fetch error:", err);
        showToast("❌ Could not load profile", "danger");
    }
}

async function saveProfile() {
    const fieldsToValidate = {
        'Full Name': document.getElementById("full_name").value.trim(),
        'Date of Birth': document.getElementById("date_of_birth").value,
        'Gender': document.getElementById("gender").value,
        'Nationality': document.getElementById("nationality").value.trim(),
        'Passport No': document.getElementById("passport_no").value.trim(),
        'Address': document.getElementById("address").value.trim(),
        'City': document.getElementById("city").value.trim(),
        'Country': document.getElementById("country").value.trim(),
        'Phone': document.getElementById("phone").value.trim()
    };

    const firstEmptyField = Object.keys(fieldsToValidate).find(key => !fieldsToValidate[key]);

    if (firstEmptyField) {
        showToast(`❌ Please fill out the "${firstEmptyField}" field.`, 'danger');
        return;
    }
    
    const formData = new FormData();
    formData.append('user_id', userId);
    Object.entries(fieldsToValidate).forEach(([key, value]) => {
        const backendKey = key.toLowerCase().replace(/ /g, '_');
        formData.append(backendKey, value);
    });
    formData.append('frequent_flyer_no', document.getElementById("frequent_flyer_no").value.trim());

    const photoInput = document.getElementById("photoInput");
    if (photoInput.files.length > 0) {
        formData.append('photo', photoInput.files[0]);
    }

    const url = profileExists 
        ? `${backendUrl}/customers/update/${userId}`
        : `${backendUrl}/customers/create`;
    const method = profileExists ? "PUT" : "POST";

    try {
        const res = await fetch(url, {
            method,
            body: formData
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Save failed");
        
        showToast("✅ Profile saved successfully!", "success");
        profileExists = true;
        
        const currentUser = JSON.parse(localStorage.getItem("user"));
        if (currentUser) {
            currentUser.profile_completed = true;
            localStorage.setItem("user", JSON.stringify(currentUser));
        }

        const redirectUrl = localStorage.getItem('redirectAfterProfileUpdate');

        if (redirectUrl) {
            localStorage.removeItem('redirectAfterProfileUpdate');
            showToast("Redirecting you to complete your booking...", "info");
            
            setTimeout(() => {
                window.location.href = redirectUrl;
            }, 1500);

        } else {
            fetchProfile(); 
        }
        
    } catch (err) {
        console.error("Save error:", err);
        showToast(err.message, "danger");
    }
}

function showToast(message, type = "info") {
    const toastContainer = document.createElement("div");
    toastContainer.style.position = "fixed";
    toastContainer.style.bottom = "20px";
    toastContainer.style.right = "20px";
    toastContainer.style.zIndex = "1050";

    const toast = document.createElement("div");
    const bg = type === "success" ? "#198754" : type === "danger" ? "#dc3545" : (type === "warning" ? "#ffc107" : "#0dcaf0");
    toast.style.background = bg;
    toast.style.color = "#fff";
    toast.style.padding = "14px 24px";
    toast.style.borderRadius = "8px";
    toast.style.boxShadow = "0 4px 12px rgba(0,0,0,0.15)";
    toast.innerText = message;

    toastContainer.appendChild(toast);
    document.body.appendChild(toastContainer);
    
    setTimeout(() => {
        toast.style.transition = 'opacity 0.5s ease';
        toast.style.opacity = '0';
        setTimeout(() => toastContainer.remove(), 500);
    }, 3000);
}
</script>
</body>
</html>