<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - FlightReserve</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --brand: #6f42c1;
            --sidebar-bg: #111827;
            --sidebar-link: #9ca3af;
            --sidebar-link-hover: #ffffff;
            --content-bg: #f8f9fc;
        }
        body { background-color: var(--content-bg); }

        /* --- RESPONSIVE SIDEBAR STYLES --- */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 250px;
            background-color: var(--sidebar-bg);
            padding: 1rem;
            transition: transform 0.3s ease-in-out;
            z-index: 1030;
        }
        .main-content {
            padding: 1rem;
            transition: margin-left 0.3s ease-in-out;
        }
        .top-header {
            background: #fff;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }

        /* Desktop view */
        @media (min-width: 992px) {
            .main-content { margin-left: 250px; }
            .sidebar { transform: translateX(0); }
        }

        /* Mobile & Tablet view */
        @media (max-width: 991.98px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; }
        }

        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1029;
            display: none;
        }
        .sidebar.active ~ .sidebar-overlay { display: block; }
        
        /* --- General Component Styles --- */
        .sidebar .navbar-brand { color: #fff; font-weight: 700; font-size: 1.5rem; text-align: center; display: block; margin-bottom: 2rem; }
        .sidebar .nav-link { color: var(--sidebar-link); padding: 0.75rem 1rem; border-radius: 8px; font-weight: 500; transition: all 0.2s; }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active { background-color: var(--brand); color: var(--sidebar-link-hover); }
        .sidebar .nav-link i { margin-right: 10px; width: 20px; text-align: center; }
        .sidebar .logout { position: absolute; bottom: 20px; left: 1rem; right: 1rem; }
        
        .stat-card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .stat-card .card-body { display: flex; align-items: center; }
        .stat-card .stat-icon { font-size: 2.5rem; padding: 1rem; border-radius: 50%; color: #fff; }
        
        .table-responsive-container { background-color: #fff; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        
        .modal-header { background: var(--brand); color: #fff; }
        .modal-header .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        .btn-brand { background-color: var(--brand); color: #fff; border: none; }
        .btn-brand:hover { background-color: #5a32a3; color: #fff; }

        /* Styles for Seat Modal */
        .seat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; text-align: center; }
        .seat-box { padding: 8px; border-radius: 6px; font-weight: 500; border: 1px solid #dee2e6; }
        .seat-box.available { background-color: #e7f5ff; color: #1971c2; border-color: #a5d8ff; }
        .seat-box.booked { background-color: #f8f9fa; color: #868e96; text-decoration: line-through; }
    </style>
</head>
<body>
    <nav class="sidebar">
        <a class="navbar-brand" href="#">FlightReserve</a>
        <ul class="nav flex-column gap-2">
            <li class="nav-item"> <a class="nav-link active" href="#" data-section="dashboard"><i class="bi bi-grid-1x2-fill"></i>Dashboard</a> </li>
            <li class="nav-item"> <a class="nav-link" href="#" data-section="airports"><i class="bi bi-building"></i>Airports</a> </li>
            <li class="nav-item"> <a class="nav-link" href="#" data-section="routes"><i class="bi bi-sign-turn-right-fill"></i>Routes</a> </li>
            <li class="nav-item"> <a class="nav-link" href="#" data-section="aircraft"><i class="bi bi-airplane-engines-fill"></i>Aircraft</a> </li>
            <li class="nav-item"> <a class="nav-link" href="#" data-section="flights"><i class="bi bi-airplane-fill"></i>Flights</a> </li>
            <li class="nav-item"> <a class="nav-link" href="#" data-section="schedules"><i class="bi bi-calendar3"></i>Schedules</a> </li>
            <li class="nav-item"> <a class="nav-link" href="#" data-section="users"><i class="bi bi-people-fill"></i>Users</a> </li>
            <li class="nav-item"> <a class="nav-link" href="#" data-section="bookings"><i class="bi bi-journal-check"></i>Bookings</a> </li>
            <li class="nav-item"> <a class="nav-link" href="#" data-section="payments"><i class="bi bi-credit-card-fill"></i>Payments</a> </li>
        </ul>
        <button class="btn btn-danger logout w-100" id="logoutBtn"><i class="bi bi-box-arrow-left"></i> Logout</button>
    </nav>
    <div class="sidebar-overlay"></div>

    <main class="main-content">
        <header class="top-header d-flex justify-content-between align-items-center d-lg-none">
            <a class="navbar-brand text-dark m-0" href="#">FlightReserve</a>
            <button class="btn" type="button" id="sidebarToggleBtn">
                <i class="bi bi-list fs-3"></i>
            </button>
        </header>

        <div id="content-area"></div>
    </main>

    <div class="modal fade" id="formModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Modal Title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body"> <form id="modalForm"></form> </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-brand" id="saveBtn">Save changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        // --- RESPONSIVE SIDEBAR LOGIC ---
        const sidebar = document.querySelector('.sidebar');
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const sidebarOverlay = document.querySelector('.sidebar-overlay');

        function toggleSidebar() {
            sidebar.classList.toggle('active');
        }

        if (sidebarToggleBtn) {
            sidebarToggleBtn.addEventListener('click', toggleSidebar);
        }
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', toggleSidebar);
        }

        function closeSidebarOnMobile() {
            if (window.innerWidth < 992 && sidebar.classList.contains('active')) {
                toggleSidebar();
            }
        }
        
        // --- EXISTING DASHBOARD LOGIC ---
        window.addEventListener('unload', function(event) {
            localStorage.removeItem('user');
            console.log("Admin session cleared from local storage.");
        });
        
        const API_BASE_URL = "https://flight-reservation-api-xv04.onrender.com";
        let currentSection = 'dashboard';
        let editId = null;
        const appData = { airports: [], routes: [], aircraft: [], seatmaps: [], flights: [], users: [] };
        const formModal = new bootstrap.Modal(document.getElementById('formModal'));
        const contentArea = document.getElementById('content-area');

        function init() {
            const user = JSON.parse(localStorage.getItem("user"));
            if (!user || user.role !== 'admin') {
                alert("Access Denied. You must be an admin to view this page.");
                window.location.href = "/login.html"; return;
            }
            const navLinks = document.querySelectorAll(".sidebar .nav-link");
            navLinks.forEach(link => {
                link.addEventListener("click", (e) => {
                    e.preventDefault();
                    navLinks.forEach(l => l.classList.remove("active"));
                    link.classList.add("active");
                    loadSection(link.getAttribute('data-section'));
                    closeSidebarOnMobile(); // Close sidebar on mobile after clicking a link
                });
            });
            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('user');
                window.location.href = '/login.html';
            });
            loadSection('dashboard');
        }
        
        async function loadSection(section) {
            currentSection = section;
            contentArea.innerHTML = `<div class="d-flex justify-content-center mt-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
            try {
                switch (section) {
                    case 'dashboard': await renderDashboard(); break;
                    case 'airports':
                        await renderTable({
                            title: 'Airports Management', endpoint: 'airports/read',
                            columns: ['ID', 'IATA', 'ICAO', 'Name', 'City', 'Country'],
                            fields: ['id', 'iata', 'icao', 'name', 'city', 'country'],
                        });
                        break;
                    case 'routes':
                        await renderTable({
                            title: 'Routes Management', endpoint: 'routes/read',
                            columns: ['ID', 'Source', 'Destination', 'Distance (NM)', 'Duration (Min)'],
                            fields: ['id', 'source_airport', 'destination_airport', 'distance_nm', 'typical_duration_min'],
                        });
                        break;
                    case 'aircraft':
                        await renderTable({
                            title: 'Aircraft Management', 
                            endpoint: 'aircraft/read',
                            columns: ['ID', 'Registration', 'Model', 'Manufacturer', 'Seat Map Name', 'Layout', 'Rows', 'Status'],
                            fields: [ 'id', 'registration_no', 'model', 'manufacturer', 'seat_map_name',
                                (item) => (item.layout && item.layout.config) ? item.layout.config : 'N/A',
                                (item) => (item.layout && item.layout.rows) ? item.layout.rows : 'N/A', 'status' ],
                        });
                        break;
                    case 'flights':
                        await renderTable({
                            title: 'Flights Management', endpoint: 'flights/read',
                            columns: ['ID', 'Flight No.', 'Source', 'Destination', 'Aircraft Reg.'],
                            fields: ['id', 'flight_number', 'source_airport_iata', 'dest_airport_iata', 'aircraft_reg'],
                        });
                        break;
                    case 'schedules':
                        const schedules = await fetchData('flightinstances/read'); 
                        const flights = await fetchData('flights/read');
                        const enrichedSchedules = schedules.map(s => ({
                            ...s,
                            flight_number: flights.find(f => f.id === s.flight_id)?.flight_number || 'N/A',
                            scheduled_departure: new Date(s.scheduled_departure).toLocaleString(),
                            scheduled_arrival: new Date(s.scheduled_arrival).toLocaleString()
                        }));
                        renderTable({
                            title: 'Schedules Management', endpoint: 'flightinstances', data: enrichedSchedules,
                            columns: ['ID', 'Flight No.', 'Departure', 'Arrival', 'Status', 'Seats'],
                            fields: [ 'id', 'flight_number', 'scheduled_departure', 'scheduled_arrival', 'status',
                                (item) => `<button class="btn btn-sm btn-outline-secondary view-seats-btn" data-id="${item.id}"><i class="bi bi-person-workspace"></i> View Seats</button>` ],
                        });
                        break;
                    case 'users':
                        await renderTable({
                            title: 'Users Management', endpoint: 'auth/read',
                            columns: ['ID', 'Username', 'Email', 'Role', 'Profile Completed'],
                            fields: ['id', 'username', 'email', 'role', 'profile_completed'],
                            noCreate: true
                        });
                        break;
                    case 'bookings':
                        await renderTable({
                            title: 'All Bookings', endpoint: 'bookings/read',
                            columns: ['ID', 'PNR', 'User ID', 'Flight Instance', 'Seats', 'Status', 'Date'],
                            fields: ['booking_id', 'pnr', 'user_id', 'flight_instance_id', 'seat_numbers', 'status', (item) => new Date(item.booking_date).toLocaleDateString()],
                            readOnly: true
                        });
                        break;
                     case 'payments':
                        await renderTable({
                            title: 'All Payments', endpoint: 'payments/read',
                            columns: ['ID', 'Booking ID', 'Amount', 'Currency', 'Method', 'Status', 'Date'],
                            fields: ['payment_id', 'booking_id', 'amount', 'currency', 'payment_method', 'status', (item) => new Date(item.payment_date).toLocaleString()],
                            readOnly: true
                        });
                        break;
                }
            } catch (error) {
                console.error(`Failed to load section ${section}:`, error);
                contentArea.innerHTML = `<div class="alert alert-danger">Failed to load content. ${error.message}</div>`;
            }
        }
        
        async function renderDashboard() {
    try {
        const [bookings, users, flights, payments] = await Promise.all([
            fetchData('bookings/read'), fetchData('auth/read'),
            fetchData('flights/read'), fetchData('payments/read')
        ]);
        
        const totalRevenue = payments.reduce((sum, p) => sum + parseFloat(p.amount), 0);
        const bookingsPerMonth = {};
        bookings.forEach(booking => {
            const month = new Date(booking.booking_date).toLocaleString('default', { month: 'short', year: 'numeric' });
            bookingsPerMonth[month] = (bookingsPerMonth[month] || 0) + 1;
        });
        const chartLabels = Object.keys(bookingsPerMonth);
        const chartData = Object.values(bookingsPerMonth);

        contentArea.innerHTML = `
            <h1 class="mb-4 d-none d-lg-block">Admin Dashboard</h1>
            <div class="row g-4">
                <div class="col-md-6 col-lg-3"><div class="card stat-card"><div class="card-body"><div class="stat-icon bg-primary"><i class="bi bi-journal-check"></i></div><div class="ms-3"><h5 class="card-title">${bookings.length}</h5><p class="card-text text-muted">Total Bookings</p></div></div></div></div>
                <div class="col-md-6 col-lg-3"><div class="card stat-card"><div class="card-body"><div class="stat-icon bg-success"><i class="bi bi-cash-coin"></i></div><div class="ms-3"><h5 class="card-title">₹${totalRevenue.toFixed(2)}</h5><p class="card-text text-muted">Total Revenue</p></div></div></div></div>
                <div class="col-md-6 col-lg-3"><div class="card stat-card"><div class="card-body"><div class="stat-icon bg-info"><i class="bi bi-people-fill"></i></div><div class="ms-3"><h5 class="card-title">${users.length}</h5><p class="card-text text-muted">Registered Users</p></div></div></div></div>
                <div class="col-md-6 col-lg-3"><div class="card stat-card"><div class="card-body"><div class="stat-icon bg-warning"><i class="bi bi-airplane-fill"></i></div><div class="ms-3"><h5 class="card-title">${flights.length}</h5><p class="card-text text-muted">Active Flights</p></div></div></div></div>
            </div>
            <div class="row mt-4"><div class="col-md-12"><div class="table-responsive-container"><h4 class="mb-3">Bookings Overview</h4><canvas id="bookingsChart"></canvas></div></div></div>`;
        
        const canvasElement = document.getElementById('bookingsChart');
        if (canvasElement) {
            // ⭐ FIX: Changed getContext('d') to getContext('2d')
            const ctx = canvasElement.getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: { 
                    labels: chartLabels, 
                    datasets: [{ 
                        label: 'Bookings per Month', 
                        data: chartData, 
                        backgroundColor: 'rgba(111, 66, 193, 0.6)', 
                        borderColor: 'rgba(111, 66, 193, 1)', 
                        borderWidth: 1 
                    }] 
                },
                options: { 
                    scales: { y: { beginAtZero: true } }, 
                    responsive: true, 
                    plugins: { legend: { position: 'top' } } 
                }
            });
        }
    } catch (error) {
        console.error("Dashboard render error:", error);
        contentArea.innerHTML = `<div class="alert alert-danger">Failed to load dashboard analytics.</div>`;
    }
}
        
        async function renderTable(config) {
            const { title, endpoint, columns, fields, data, readOnly = false, noCreate = false } = config;
            const tableData = data || await fetchData(endpoint);
            let tableHeaders = columns.map(col => `<th>${col}</th>`).join('');
            if (!readOnly) tableHeaders += '<th>Actions</th>';
            let tableRows = tableData.map(item => {
                let row = fields.map(field => `<td>${(typeof field === 'function') ? field(item) : (item[field] || 'N/A')}</td>`).join('');
                if (!readOnly) {
                    row += `<td>
                                <div class="d-flex">
                                    <button class="btn btn-sm btn-info me-2 edit-btn" data-id="${item.id || item.user_id || item.booking_id}"><i class="bi bi-pencil-fill"></i></button>
                                    <button class="btn btn-sm btn-danger delete-btn" data-id="${item.id || item.user_id || item.booking_id}"><i class="bi bi-trash-fill"></i></button>
                                </div>
                            </td>`;
                }
                return `<tr>${row}</tr>`;
            }).join('');
            contentArea.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                    <h1>${title}</h1>
                    ${!readOnly && !noCreate ? `<button class="btn btn-brand" id="createNewBtn"><i class="bi bi-plus-circle-fill"></i> Create New</button>` : ''}
                </div>
                <div class="table-responsive-container">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead><tr>${tableHeaders}</tr></thead>
                            <tbody>${tableRows.length > 0 ? tableRows : `<tr><td colspan="${columns.length + (readOnly ? 0 : 1)}" class="text-center">No data available.</td></tr>`}</tbody>
                        </table>
                    </div>
                </div>`;
            if (!readOnly && !noCreate) document.getElementById("createNewBtn").addEventListener("click", () => handleCreate());
            if (!readOnly) {
                document.querySelectorAll(".edit-btn").forEach(btn => btn.addEventListener("click", e => handleEdit(e.currentTarget.dataset.id)));
                document.querySelectorAll(".delete-btn").forEach(btn => btn.addEventListener("click", e => handleDelete(e.currentTarget.dataset.id)));
            }
            document.querySelectorAll(".view-seats-btn").forEach(btn => btn.addEventListener("click", e => handleViewSeats(e.currentTarget.dataset.id)));
        }

        async function handleViewSeats(instanceId) {
            const modalTitle = document.getElementById("modalTitle");
            const modalBody = document.getElementById("modalForm");
            const saveBtn = document.getElementById("saveBtn");
            modalTitle.innerText = `Loading Seats for Schedule #${instanceId}...`;
            modalBody.innerHTML = `<div class="d-flex justify-content-center mt-3"><div class="spinner-border" role="status"></div></div>`;
            saveBtn.style.display = 'none';
            formModal.show();
            try {
                const seats = await fetchData(`flightseats/instance/${instanceId}`);
                modalTitle.innerText = `Seats for Schedule #${instanceId} (${seats.length} total)`;
                if (seats.length === 0) {
                    modalBody.innerHTML = `<p class="text-center text-muted">No seats found for this schedule.</p>`;
                    return;
                }
                const seatGridHTML = seats.map(seat => `<div class="seat-box ${seat.status}">${seat.seat_number}</div>`).join('');
                modalBody.innerHTML = `<div class="seat-grid">${seatGridHTML}</div>`;
            } catch (error) {
                console.error("Failed to load seats:", error);
                modalTitle.innerText = 'Error';
                modalBody.innerHTML = `<div class="alert alert-danger">Could not load seat information.</div>`;
            }
        }

        function handleCreate() {
            editId = null;
            document.getElementById("modalTitle").innerText = `Create New ${capitalize(currentSection.slice(0, -1))}`;
            document.getElementById("modalForm").innerHTML = getFormFields(currentSection);
            populateDropdowns(currentSection);
            document.getElementById('saveBtn').style.display = 'inline-block';
            formModal.show();
        }

        async function handleEdit(id) {
            editId = id;
            const endpoint = (currentSection === 'users') ? 'auth/read' : (currentSection === 'schedules') ? 'flightinstances/read' : `${currentSection}/read`;
            const data = await fetchData(`${endpoint}/${id}`);
            document.getElementById("modalTitle").innerText = `Edit ${capitalize(currentSection.slice(0, -1))} #${id}`;
            document.getElementById("modalForm").innerHTML = getFormFields(currentSection, data);
            await populateDropdowns(currentSection, data);
            document.getElementById('saveBtn').style.display = 'inline-block';
            formModal.show();
        }

        async function handleDelete(id) {
            if (confirm(`Are you sure you want to delete this item (#${id})? This action cannot be undone.`)) {
                try {
                    let endpoint;
                    switch (currentSection) {
                        case 'schedules': endpoint = 'flightinstances'; break;
                        case 'users': endpoint = 'auth'; break;
                        default: endpoint = currentSection;
                    }
                    await sendRequest(`${endpoint}/delete/${id}`, 'DELETE');
                    loadSection(currentSection);
                } catch (error) {
                    console.error("Delete failed:", error);
                    alert(`Deletion failed: ${error.message}`);
                }
            }
        }
        
        document.getElementById("saveBtn").addEventListener("click", async () => {
             const form = document.getElementById("modalForm");
             const formData = new FormData(form);
             let body;
             let endpoint;

             if (currentSection === 'aircraft') {
                 body = JSON.stringify(Object.fromEntries(formData.entries()));
                 endpoint = editId ? `${currentSection}/update/${editId}` : `${currentSection}/create-with-seatmap`;
             } else if (currentSection === 'schedules' && !editId) {
                 body = JSON.stringify(Object.fromEntries(formData.entries()));
                 endpoint = `flightinstances/create-with-seats`;
             } else {
                 const rawData = Object.fromEntries(formData.entries());
                 if (currentSection === 'users') { delete rawData.username; delete rawData.email; }
                 body = JSON.stringify(rawData);
                 
                 let baseEndpoint;
                 switch(currentSection) {
                     case 'schedules': baseEndpoint = 'flightinstances'; break;
                     case 'users': baseEndpoint = 'auth'; break;
                     default: baseEndpoint = currentSection;
                 }
                 endpoint = editId ? `${baseEndpoint}/update/${editId}` : `${baseEndpoint}/create`;
             }

             const method = editId ? 'PUT' : 'POST';
             try {
                 await sendRequest(endpoint, method, body);
                 formModal.hide();
                 loadSection(currentSection);
             } catch (error) {
                 console.error("Save failed:", error);
                 alert(`Save failed: ${error.message}`);
             }
        });

        function getFormFields(section, data = {}) {
            switch (section) {
                case 'aircraft':
                    if (editId) {
                        const layout = data.layout || {};
                          return `<h5>Aircraft Details</h5>
                                  <div class="row g-3 mb-4">
                                      <div class="col-md-6"><label class="form-label">Registration No</label><input type="text" name="registration_no" class="form-control" value="${data.registration_no || ''}" required></div>
                                      <div class="col-md-6"><label class="form-label">Model</label><input type="text" name="model" class="form-control" value="${data.model || ''}" required></div>
                                      <div class="col-md-6"><label class="form-label">Manufacturer</label><input type="text" name="manufacturer" class="form-control" value="${data.manufacturer || ''}" required></div>
                                      <div class="col-md-6"><label class="form-label">Status</label><select name="status" class="form-select"><option value="active" ${data.status === 'active' ? 'selected' : ''}>Active</option><option value="maintenance" ${data.status === 'maintenance' ? 'selected' : ''}>Maintenance</option></select></div>
                                  </div><hr>
                                  <h5>Edit Seat Map Details</h5>
                                  <div class="row g-3">
                                      <div class="col-md-12"><label class="form-label">Seat Map Name</label><input type="text" name="seat_map_name" class="form-control" value="${data.seat_map_name || ''}" required></div>
                                      <div class="col-md-6"><label class="form-label">Number of Rows</label><input type="number" name="num_rows" class="form-control" value="${layout.rows || ''}" placeholder="e.g., 30" required></div>
                                      <div class="col-md-6"><label class="form-label">Seat Layout</label><input type="text" name="layout_string" class="form-control" value="${layout.config || ''}" placeholder="e.g., 3-3 or 2-3" required></div>
                                  </div>`;
                    }
                    return `<h5>Aircraft Details</h5>
                            <div class="row g-3 mb-4">
                                <div class="col-md-4"><label class="form-label">Registration No</label><input type="text" name="registration_no" class="form-control" required></div>
                                <div class="col-md-4"><label class="form-label">Model</label><input type="text" name="model" class="form-control" required></div>
                                <div class="col-md-4"><label class="form-label">Manufacturer</label><input type="text" name="manufacturer" class="form-control" required></div>
                            </div><hr>
                            <h5>New Seat Map Details</h5>
                            <div class="row g-3">
                                <div class="col-md-12"><label class="form-label">Seat Map Name</label><input type="text" name="seat_map_name" class="form-control" placeholder="e.g., A320 Standard" required></div>
                                <div class="col-md-6"><label class="form-label">Number of Rows</label><input type="number" name="num_rows" class="form-control" placeholder="e.g., 30" required></div>
                                <div class="col-md-6"><label class="form-label">Seat Layout</label><input type="text" name="layout_string" class="form-control" placeholder="e.g., 3-3 or 2-3" required></div>
                            </div>`;
                case 'airports':
                    return `<div class="row g-3"> <div class="col-md-6"><label class="form-label">IATA Code</label><input type="text" name="iata" class="form-control" value="${data.iata || ''}" required></div> <div class="col-md-6"><label class="form-label">ICAO Code</label><input type="text" name="icao" class="form-control" value="${data.icao || ''}" required></div> <div class="col-md-12"><label class="form-label">Airport Name</label><input type="text" name="name" class="form-control" value="${data.name || ''}" required></div> <div class="col-md-6"><label class="form-label">City</label><input type="text" name="city" class="form-control" value="${data.city || ''}" required></div> <div class="col-md-6"><label class="form-label">Country</label><input type="text" name="country" class="form-control" value="${data.country || ''}" required></div> <div class="col-md-6"><label class="form-label">Timezone</label><input type="text" name="tz" class="form-control" value="${data.tz || 'Asia/Kolkata'}" required></div> </div>`;
                case 'routes':
                    return `<div class="row g-3"> <div class="col-md-6"><label class="form-label">Source Airport</label><select name="source_airport_id" id="source_airport_id" class="form-select" required ${data.id ? 'disabled' : ''}></select></div> <div class="col-md-6"><label class="form-label">Destination Airport</label><select name="dest_airport_id" id="dest_airport_id" class="form-select" required ${data.id ? 'disabled' : ''}></select></div> <div class="col-md-6"><label class="form-label">Distance (NM)</label><input type="number" name="distance_nm" class="form-control" value="${data.distance_nm || ''}" required></div> <div class="col-md-6"><label class="form-label">Duration (minutes)</label><input type="number" name="typical_duration_min" class="form-control" value="${data.typical_duration_min || ''}" required></div> </div>`;
                case 'flights':
                     return `<div class="row g-3"> <div class="col-md-6"><label class="form-label">Flight Number</label><input type="text" name="flight_number" class="form-control" value="${data.flight_number || ''}" required></div> <div class="col-md-6"><label class="form-label">Route</label><select name="route_id" id="route_id" class="form-select" required></select></div> <div class="col-md-6"><label class="form-label">Aircraft</label><select name="aircraft_id" id="aircraft_id" class="form-select" required></select></div> <div class="col-md-6"><label class="form-label">Status</label><select name="status" class="form-select"><option value="scheduled" ${data.status === 'scheduled' ? 'selected' : ''}>Scheduled</option></select></div> <div class="col-md-4"><label class="form-label">Departure Time</label><input type="time" name="departure_time" class="form-control" value="${data.departure_time || ''}" required></div> <div class="col-md-4"><label class="form-label">Arrival Time</label><input type="time" name="arrival_time" class="form-control" value="${data.arrival_time || ''}" required></div> <div class="col-md-4"><label class="form-label">Frequency</label><input type="text" name="frequency" class="form-control" value="${data.frequency || 'Daily'}" required></div> </div>`;
                case 'schedules':
                      if (editId) {
                          return `<div class="row g-3">
                                      <div class="col-md-12">
                                          <label class="form-label">Flight</label>
                                          <select name="flight_id" id="flight_id" class="form-select" required disabled></select>
                                          <small class="text-muted">Flight cannot be changed when editing a schedule.</small>
                                      </div>
                                      <div class="col-md-6">
                                          <label class="form-label">Scheduled Departure</label>
                                          <input type="datetime-local" name="scheduled_departure" class="form-control" value="${data.scheduled_departure ? new Date(new Date(data.scheduled_departure).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0,16) : ''}" required>
                                      </div>
                                      <div class="col-md-6">
                                          <label class="form-label">Scheduled Arrival</label>
                                          <input type="datetime-local" name="scheduled_arrival" class="form-control" value="${data.scheduled_arrival ? new Date(new Date(data.scheduled_arrival).getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0,16) : ''}" required>
                                      </div>
                                      <div class="col-md-12">
                                          <label class="form-label">Status</label>
                                          <select name="status" class="form-select">
                                              <option value="on-time" ${data.status === 'on-time' ? 'selected' : ''}>On Time</option>
                                              <option value="delayed" ${data.status === 'delayed' ? 'selected' : ''}>Delayed</option>
                                              <option value="cancelled" ${data.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                          </select>
                                      </div>
                                  </div>`;
                      } else {
                          return `<div class="row g-3">
                                      <div class="col-md-12">
                                          <label class="form-label">Flight</label>
                                          <select name="flight_id" id="flight_id" class="form-select" required></select>
                                      </div>
                                      <div class="col-md-6">
                                          <label class="form-label">Departure Date</label>
                                          <input type="date" name="departure_date" class="form-control" required>
                                      </div>
                                      <div class="col-md-6">
                                          <label class="form-label">Arrival Date</label>
                                          <input type="date" name="arrival_date" class="form-control" required>
                                      </div>
                                      <div class="col-md-12">
                                          <label class="form-label">Initial Status</label>
                                          <select name="status" class="form-select">
                                              <option value="on-time">On Time</option>
                                              <option value="delayed">Delayed</option>
                                              <option value="cancelled">Cancelled</option>
                                          </select>
                                      </div>
                                  </div>`;
                      }
                case 'users':
                    return `<p><strong>Username:</strong> ${data.username}</p> <p><strong>Email:</strong> ${data.email}</p> <div class="mb-3"><label class="form-label">Role</label><select name="role" class="form-select"><option value="customer" ${data.role === 'customer' ? 'selected' : ''}>Customer</option><option value="admin" ${data.role === 'admin' ? 'selected' : ''}>Admin</option></select></div>`;
                default: return '<p>Form not available for this section.</p>';
            }
        }
        
        async function populateDropdowns(section, prefillData = {}) {
            switch (section) {
                case 'aircraft': break;
                case 'routes': appData.airports = await fetchData('airports/read'); populateSelect('source_airport_id', appData.airports, 'id', 'name', prefillData.source_airport_id); populateSelect('dest_airport_id', appData.airports, 'id', 'name', prefillData.dest_airport_id); break;
                case 'flights': appData.routes = await fetchData('routes/read'); appData.aircraft = await fetchData('aircraft/read'); populateSelect('route_id', appData.routes, 'id', (r) => `${r.source_airport} -> ${r.destination_airport}`, prefillData.route_id); populateSelect('aircraft_id', appData.aircraft, 'id', 'registration_no', prefillData.aircraft_id); break;
                case 'schedules': appData.flights = await fetchData('flights/read'); populateSelect('flight_id', appData.flights, 'id', (f) => `${f.flight_number} (${f.source_airport_iata}-${f.dest_airport_iata})`, prefillData.flight_id); break;
            }
        }
        
        async function fetchData(endpoint) { const res = await fetch(`${API_BASE_URL}/${endpoint}`); if (!res.ok) throw new Error(`Failed to fetch ${endpoint}: ${res.statusText}`); return res.json(); }
        async function sendRequest(endpoint, method, body = null) { const options = { method, headers: { 'Content-Type': 'application/json' } }; if (body) options.body = body; const res = await fetch(`${API_BASE_URL}/${endpoint}`, options); if (!res.ok) { const errorData = await res.json(); throw new Error(errorData.error || `Request failed with status ${res.status}`); } return res.json(); }
        function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
        function populateSelect(selectId, data, valueField, textField, selectedValue = null) { const select = document.getElementById(selectId); if (!select) return; select.innerHTML = '<option value="">-- Select --</option>'; data.forEach(item => { const text = typeof textField === 'function' ? textField(item) : item[textField]; const isSelected = item[valueField] == selectedValue ? 'selected' : ''; select.innerHTML += `<option value="${item[valueField]}" ${isSelected}>${text}</option>`; }); }
        
        init();
    });
    </script>
</body>
</html>