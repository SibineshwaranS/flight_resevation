<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FlightReserve – Seat Selection</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    :root {
      --brand: #6f42c1;
      --gradient: linear-gradient(135deg, #6f42c1, #a78bfa);
      --ink: #1f2937;
      --muted: #6b7280;
      --bg-soft: #f8f9fc;
    }
    body {
      background-color: var(--bg-soft);
      font-family: 'Inter', sans-serif;
      color: var(--ink);
    }
    header {
      margin-top: 70px;
      background: var(--gradient);
      color: #fff;
      padding: 2.5rem 1rem;
      text-align: center;
      border-radius: 0 0 28px 28px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    header h2 {
      font-weight: 700;
      font-size: 2rem;
      margin: 0;
    }

    /* Navbar */
    .navbar {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
    .navbar-brand {
      font-size: 1.6rem;
      font-weight: 800;
      background: var(--gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      -webkit-text-fill-color: transparent;
    }
    
    .btn-back {
        font-weight: 600;
        background: var(--gradient);
        color: #fff !important;
        border-radius: 30px;
        padding: 8px 18px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: none;
        transition: 0.3s;
        box-shadow: 0 4px 12px rgba(111, 66, 193, 0.2);
    }
    .btn-back:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(111, 66, 193, 0.35);
    }

    
    /* Seat Map - REVISED FOR DYNAMIC LAYOUT */
    .seat-map-wrapper {
        overflow-x: auto; /* Allows scrolling on small screens */
        padding: 1rem;
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.07);
    }

    .seat-map {
      display: grid;
      gap: 12px 10px; /* row-gap, column-gap */
      justify-content: center;
      margin: 0 auto;
      min-width: 500px; /* Prevents squishing on slightly smaller screens */
    }

    /* A new element representing the empty aisle space */
    .aisle {
        grid-column-end: span 1; /* Ensures it takes up one grid column */
    }
    
    /* A new element for the row number label */
    .row-label {
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: var(--muted);
        font-size: 0.9rem;
    }

    .seat {
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: 0.25s;
    }
    .seat.available {
      background: #e5dbff;  
      color: var(--brand);
      transition: background 0.3s, transform 0.2s;
    }
    .seat.available:hover:not(.selected) {
      background: #d6c9f5;
      color: #222;
      transform: translateY(-3px);
    }
    .seat.selected {
      background: var(--brand) !important;
      color: #fff !important;
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(111, 66, 193, 0.5);
    }
    .seat.booked {
      background: #e9ecef;
      color: var(--muted);
      cursor: not-allowed;
    }

    .legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      font-size: 0.9rem;
    }
    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .legend-box {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      display: inline-block;
    }
    .legend .available .legend-box { background: #e5dbff; }
    .legend .booked .legend-box { background: #e9ecef; }
    .legend .selected .legend-box { background: var(--brand); }

    .btn-confirm {
      margin-top: 30px;
      background: var(--gradient);
      color: #fff;
      border-radius: 30px;
      padding: 12px 30px;
      font-weight: 600;
      border: none;
      transition: 0.3s;
    }
    .btn-confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(111, 66, 193, 0.4);
    }
      .btn-confirm:disabled {
        background: #ced4da;
    }

    footer {
      background: #111827;
      color: #cfd2e3;
      text-align: center;
      padding: 2rem 1rem;
      margin-top: 60px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
      <a class="navbar-brand" href="/index.html">FlightReserve</a>
      <a href="/userflights.html" class="btn-back ms-auto">
        <i class="bi bi-arrow-left-circle"></i>
        <span>Back</span>
      </a>
    </div>
  </nav>

  <header>
    <h2> Book Your Seat </h2>
    <p class="lead">Choose your preferred seat for <span id="flightRoute">Loading...</span></p>
  </header>

  <div class="container text-center my-5">
    <div id="seatMapContainer" class="seat-map-wrapper">
      <p class="text-muted">Loading seat map...</p>
    </div>

    <div class="legend">
      <span class="available"><span class="legend-box"></span> Available</span>
      <span class="booked"><span class="legend-box"></span> Booked</span>
      <span class="selected"><span class="legend-box"></span> Selected</span>
    </div>

    <button id="confirmBtn" class="btn btn-confirm" disabled>
      <i class="bi bi-check-circle me-2"></i> Confirm Booking
    </button>
  </div>

  <footer>
    <p>&copy; 2025 FlightReserve. All rights reserved.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const seatMapContainer = document.getElementById("seatMapContainer");
    const flightRoute = document.getElementById("flightRoute");
    const confirmBtn = document.getElementById("confirmBtn");
    let selectedSeats = [];
    let flightInstanceId = null;

    const params = new URLSearchParams(window.location.search);
    flightInstanceId = params.get("instance_id");
    const routeName = params.get("route") || "";
    flightRoute.textContent = routeName;

    // ⭐⭐⭐ START OF CORRECTED LOGIC ⭐⭐⭐
  async function loadSeats() {
      if (!flightInstanceId) {
        seatMapContainer.innerHTML = `<p class="text-danger">Flight instance ID is missing.</p>`;
        return;
      }
      try {
        const res = await fetch(`https://flight-resevation-api.onrender.com/flightinstances/seatmap/${flightInstanceId}`);
        if (!res.ok) {
            throw new Error(`Failed to fetch: ${res.statusText}`);
        }
        const data = await res.json();
        
        // FIX: Remove JSON.parse(). 'data.layout' is already a JavaScript object
        // because the backend driver and the frontend fetch API already parsed it.
        const layout = data.layout; 
        const seats = data.seats;

        if (!seats || seats.length === 0) {
          seatMapContainer.innerHTML = `<p class="text-danger">No seats found for this flight.</p>`;
          return;
        }

        renderSeatMap(layout, seats);

      } catch (err) {
        seatMapContainer.innerHTML = `<p class="text-danger">⚠️ Failed to load seat map</p>`;
        console.error(err);
      }
    }
    // ⭐⭐⭐ END OF CORRECTED LOGIC ⭐⭐⭐
    
    function renderSeatMap(layout, seats) {
      seatMapContainer.innerHTML = ''; // Clear loading message
      const grid = document.createElement('div');
      grid.classList.add('seat-map');

      // 1. Parse the layout configuration (e.g., "2-3" -> [2, 3])
      const seatGroups = layout.config.split('-').map(n => parseInt(n, 10));
      const totalColumns = seatGroups.reduce((sum, count) => sum + count, 0) + (seatGroups.length - 1) + 1; // Seats + Aisles + RowLabel

      // 2. Dynamically set the grid-template-columns CSS property
      // 'auto' is for the row number label. '0.7fr' is for the aisle.
      const gridTemplateColumns = 'auto ' + seatGroups.map(group => `repeat(${group}, 1fr)`).join(' 0.7fr ');
      grid.style.gridTemplateColumns = gridTemplateColumns;

      // 3. Build the grid row by row
      for (let rowNum = 1; rowNum <= layout.rows; rowNum++) {
        // Add Row Number Label
        const rowLabel = document.createElement('div');
        rowLabel.classList.add('row-label');
        rowLabel.textContent = rowNum;
        grid.appendChild(rowLabel);

        let seatIndexInRow = 0; // Tracks the letter ('A', 'B', etc.)

        seatGroups.forEach((groupSize, index) => {
          // Add seats for this group
          for (let i = 0; i < groupSize; i++) {
            const seatLetter = layout.seats_per_row[seatIndexInRow];
            const seatNumber = `${rowNum}${seatLetter}`;
            const seatData = seats.find(s => s.seat_number === seatNumber);
            
            const div = document.createElement('div');
            div.classList.add('seat');
            div.textContent = seatNumber;

            if (seatData) {
              if (seatData.status === 'available') {
                div.classList.add('available');
                div.addEventListener('click', () => toggleSeat(seatData, div));
              } else {
                div.classList.add('booked');
              }
            } else {
              // Fallback for missing seat data
              div.classList.add('booked');
              div.textContent = 'N/A';
            }
            grid.appendChild(div);
            seatIndexInRow++;
          }

          // Add an aisle between groups
          if (index < seatGroups.length - 1) {
            const aisle = document.createElement('div');
            aisle.classList.add('aisle');
            grid.appendChild(aisle);
          }
        });
      }

      seatMapContainer.appendChild(grid);
    }
    // ⭐⭐⭐ END OF REVISED LOGIC ⭐⭐⭐

    function toggleSeat(seat, element) {
      if (element.classList.contains("selected")) {
        element.classList.remove("selected");
        selectedSeats = selectedSeats.filter((s) => s.seat_id !== seat.seat_id);
      } else {
        element.classList.add("selected");
        selectedSeats.push(seat);
      }
      confirmBtn.disabled = selectedSeats.length === 0;
    }

    confirmBtn.addEventListener("click", () => {
      if (selectedSeats.length === 0) {
        alert("⚠️ Please select at least one seat.");
        return;
      }

      const user = JSON.parse(localStorage.getItem("user"));
      if (!user) {
        alert("Please login first!");
        window.location.href = "/login.html";
        return;
      }
      
      if (typeof user.profile_completed === 'undefined') {
          alert("Error: User data is outdated. Please log out and log in again.");
          return;
      }

      // Prepare booking info
      const seatNumbersStr = selectedSeats.map(s => s.seat_number).join(",");
      const bookingInfo = {
        user_id: user.id,
        flight_instance_id: flightInstanceId,
        flight_route: routeName,
        seat_numbers: seatNumbersStr,
        price_per_seat: 300,
        total_price: 300 * selectedSeats.length
      };
      
      localStorage.setItem("pendingBooking", JSON.stringify(bookingInfo));

      // Redirect based on profile completion
      if (user.profile_completed) {
        console.log("Profile complete. Redirecting to payment.");
        window.location.href = "/userpayment.html";
      } else {
        alert("Please complete your personal details before booking.");
        localStorage.setItem('redirectAfterProfileUpdate', '/userpayment.html');
        window.location.href = "/customerprofile.html";
      }
    });

    loadSeats();
  </script>
</body>

</html>

